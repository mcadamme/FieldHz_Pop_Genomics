---
title: "Linkage analysis for H.zea CHR13 marker with larval growth"
author: "Katherine Taylor and Megan Fritz"
date: "written Jan. 8, 2021"
output: github_document
---

##Mapping families on treated and untreated leaf tissue incorporated diet.
One F2 mapping family was generated and progeny split into two groups at 48h after hatching - half were placed on diet with untreated leaf tissue (orange), the other half were placed on diet containing Cry1Ab treated leaf tissue (blue).  A second F2 mapping family was generated and progeny were also split into two groups at 48h after hatching - half were placed on diet containing Cry1A.105 + Cry2Ab2 treated leaf tissue (purple).  While we put the other half of the family on diet with untreated leaf tissue from a sweet corn isoline with the same genetic background as the two-toxin treated tissue, the data are not shown for simplicity. All larvae were allowed to feed for 7 days and then weighed.

```{r Family 1, include = FALSE}
library(magrittr);library(dplyr);library(ggplot2);library(MASS); library(caTools); library(lme4)

genotypes1 <- read.csv("~/Downloads/Tabash_Reanalysis/genotypes_BV-BA52_BZM_P11_A1.csv", header = T)

phenotypes1 <- read.csv("~/Downloads/Tabash_Reanalysis/BV_BA52_P11_BZM_A1_Scored.csv", header = T)

phenotypes1 <- phenotypes1 %>% 
  mutate(end_weight_mg = Individual.Larvae.Weight * 1000)

BV_BA52_BZM_P11_A1 <- merge(phenotypes1, genotypes1, by = c("tray", "square", "row", "well"))

BV_BA52_BZM_P11_A1_DD <- BV_BA52_BZM_P11_A1 %>%
  filter (Treatment == "DD") %>%
  filter (genotype_3749 != "", genotype_9409b != "")

BV_BA52_BZM_P11_A1_CL <- BV_BA52_BZM_P11_A1 %>%
  filter (Treatment == "CL") %>%
  filter (genotype_9409b != "")
```

```{r Family 2, include = FALSE}
genotypes2 <- read.csv("~/Downloads/Tabash_Reanalysis/genotypes_BV_CV98_03_BZF_I9_9.16.20.csv")

phenotypes2 <- read.csv("~/Downloads/Tabash_Reanalysis/BV_CV98_O3_BZF_I9_Scored.csv")

phenotypes2 <- phenotypes2 %>% 
  mutate(end_weight_mg = Individual.Larvae.Weight * 1000)

BV_CV98_03_BZF_I9_DD <- merge(phenotypes2, genotypes2, by = c("tray", "square", "row", "well")) %>%
  filter (genotype_3749 != "", genotype_9409b != "")
```

```{r joining two datasets just for plot, include = FALSE}

joined <- data.frame(rbind(BV_BA52_BZM_P11_A1_DD[,c(6,7,12,16)], BV_BA52_BZM_P11_A1_CL[,c(6,7,12,16)], BV_CV98_03_BZF_I9_DD[,c(6,7,11,13)]))
joined$TreatByFam <- paste(joined$Population, "", joined$Treatment)
```

```{r}

joined %>%
  filter (genotype_9409b != "") %>%
ggplot(aes(x = genotype_9409b, y = end_weight_mg, fill = TreatByFam, color = TreatByFam )) +
  geom_boxplot(fatten = 1, alpha = 0.8, notch = F) +
  geom_point(position=position_jitterdodge(jitter.width = 0.3)) +
  labs(y = "Weight (mg)", x = "") +
  scale_y_continuous(breaks = c(0, 100, 200, 300)) +
  ylim(0,350) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_x_discrete(breaks  = c("GG", "AG", "AA"),
                   labels = c("A", "A/V", "V")) +
    scale_fill_manual(name="Treatment By Family",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) +
  scale_color_manual(name="Treatment By Family ",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) 


```

## Counts of larvae with each genotype & test for mendelian seg
I tried the chisq.test function with and without simulate.p.value, the latter of which is supposed to be better for smaller sample sizes.  It did not change the outcome.
```{r}
#test of mendelian segregation

exp_props <- c(0.25, 0.5, 0.25)

geno9409_dist_BCO805_DD <- as.matrix(table(BV_BA52_BZM_P11_A1_DD$genotype_9409b))#allele freqs diag dose BC0805
print(geno9409_dist_BCO805_DD[-1,])#AA is the derived genotype in the field
chisq.test(geno9409_dist_BCO805_DD[-1,], exp_props, simulate.p.value = T)


geno9409_dist_BCO805_CL <- as.matrix(table(BV_BA52_BZM_P11_A1_CL$genotype_9409b))#allele freqs control diet
print(geno9409_dist_BCO805_CL[-1,])#AA is the derived genotype in the field
chisq.test(geno9409_dist_BCO805_CL[-1,], exp_props, simulate.p.value = T)


geno9409_dist_Obs_DD <- as.matrix(table(BV_CV98_03_BZF_I9_DD$genotype_9409b))#allele freqs control diet
print(geno9409_dist_Obs_DD)#AA is the derived genotype in the field
chisq.test(geno9409_dist_Obs_DD, exp_props, simulate.p.value = T)


```

## Anova and data transformation for Family 1 - Bv-BA52
We check the assumptions with plots and a shapiro test and then run a boxcox test to determine the appropiate transformation. The lambda value of ~0.5 suggests a square root transformation for individuals on treated diet.  Nothing needed for controls.

Progeny on treated diet

```{r}
fitDD <- aov(end_weight_mg ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD)

shapiro.test(resid(fitDD))
plot(fitDD)

boxcox(fitDD, plotit = TRUE)
```

Progeny on untreated diet
```{r}
fitCL <- aov(end_weight_mg ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_CL)

shapiro.test(resid(fitCL))#no transformation needed.
plot(fitCL)

boxcox(fitCL, plotit = TRUE)
```


For progeny on treated diet, trying a non-parametric test because the residuals are not normally distributed.
```{r}

kruskal.test(end_weight_mg ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD)


```

Then tried a parametric test with sqrt transformed responses.
```{r}

fit_BV_BA52_BZM_P11_A1_DD <- aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD)
summary(fit_BV_BA52_BZM_P11_A1_DD)


shapiro.test(resid(fit_BV_BA52_BZM_P11_A1_DD))#transformation worked
```


Just ran parametric test for individuals raised up on untreated diet.
```{r}
fit_BV_BA52_BZM_P11_A1_CL <- aov(end_weight_mg ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_CL)
summary(fit_BV_BA52_BZM_P11_A1_CL)

shapiro.test(resid(fit_BV_BA52_BZM_P11_A1_CL))#shows no transformation needed.

```


#What about a glm? 

Blocking on square because individuals within the same square got diet from the same syringe.
```{r}

fit_glmF <- lmer(sqrt(end_weight_mg) ~ 1 + genotype_9409b + (1|square), data = BV_BA52_BZM_P11_A1_DD)
fit_glmR <- lmer(sqrt(end_weight_mg) ~ 1 + (1|square), data = BV_BA52_BZM_P11_A1_DD)

summary(fit_glmF)

anova(fit_glmR, fit_glmF)#adding the blocking factor doesn't help.

#forcing full model effects without the slope.
fit_glmF2 <- lmer(sqrt(end_weight_mg) ~ 0 + genotype_9409b + (1|square), data = BV_BA52_BZM_P11_A1_DD)
summary(fit_glmF2)

#now for the controls
fit_glmF <- lmer(end_weight_mg ~ 1 + genotype_9409b + (1|square), data = BV_BA52_BZM_P11_A1_CL)
fit_glmR <- lmer(end_weight_mg ~ 1 + (1|square), data = BV_BA52_BZM_P11_A1_CL)

summary(fit_glmF)

anova(fit_glmR, fit_glmF)#but the controls look like there may be statistically significant differences in growth.


```

## Excluding small individuals.  Some progeny from Family 1 were still alive at the end of the assay but with failure to thrive phenotypes, even in the controls.
Removing small individuals BV_BA52_BZM_P11_A1_DD does not change the outcome.

```{r}
BV_BA52_BZM_P11_A1_DD_20 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 20)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_20))

BV_BA52_BZM_P11_A1_DD_25 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 25)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_25))

BV_BA52_BZM_P11_A1_DD_30 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 30)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_30))

BV_BA52_BZM_P11_A1_DD_35 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 35)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_35))

BV_BA52_BZM_P11_A1_DD_40 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 40)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_40))



```


## Anova and data transformation for Family 2 - Bv-CV98
Also check assumptions of normality with plots and a shapiro test and then run a boxcox test to determine the appropiate transformation. The lambda value of ~0.5 suggests a square root transformation for individuals on treated diet.  Nothing needed for controls.

Progeny on treated diet

```{r}
fitDD <- aov(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD)

shapiro.test(resid(fitDD))#while this is not coming up with a p-value < 0.05, it still seems pretty close to non-normally distributed.
plot(fitDD)

boxcox(fitDD, plotit = TRUE)
```



Gonna try a non-parametric test because the residuals questionable.
```{r}

kruskal.test(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD)


```

Then tried a parametric test with sqrt transformed responses.
```{r}

fit_BV_CV98_03_BZF_I9_DD <- aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD)
summary(fit_BV_CV98_03_BZF_I9_DD)


shapiro.test(resid(fit_BV_CV98_03_BZF_I9_DD))#transformation worked
```


#A glm for Family 2?

Blocking on square because individuals within the same square got diet from the same syringe.
```{r}

fit_glmF <- lmer(sqrt(end_weight_mg) ~ 1 + genotype_9409b + (1|square), data = BV_CV98_03_BZF_I9_DD)
fit_glmR <- lmer(sqrt(end_weight_mg) ~ 1 + (1|square), data = BV_CV98_03_BZF_I9_DD)

summary(fit_glmF)

anova(fit_glmR, fit_glmF)#adding the blocking factor doesn't help.


```


## Excluding small individuals.  Some progeny were still alive but with failure to thrive phenotypes.
Removing small individuals only impacts the outcome in one case - removal of progeny with weights of 30mg or less.

```{r}
BV_CV98_03_BZF_I9_DD_20 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 20)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_20))

BV_CV98_03_BZF_I9_DD_25 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 25)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_25))

BV_CV98_03_BZF_I9_DD_30 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 30)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_30))

BV_CV98_03_BZF_I9_DD_35 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 35)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_35))

BV_CV98_03_BZF_I9_DD_40 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 40)

summary(aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_40))



```

## Final thing.  Since filtering out an end weight of 30 or less made a difference for the anova in Family 2 on ObsII, gonna make a plot with those filtered to see what it looks like.  The figure clearly shows that this randomly chosen cutoff value produces a trend in the data that is inconsistent with our field study.  Furthermore when we removed individuals with weights slightly higher (up to 40 mg or less), the model returns to no statistical significance. 
```{r}

joined_30 <- joined %>%
  filter (end_weight_mg > 30)

joined_30 %>%
  filter (genotype_9409b != "") %>%
ggplot(aes(x = genotype_9409b, y = end_weight_mg, fill = TreatByFam, color = TreatByFam )) +
  geom_boxplot(fatten = 1, alpha = 0.8, notch = F) +
  geom_point(position=position_jitterdodge(jitter.width = 0.3)) +
  labs(y = "Weight (mg)", x = "") +
  scale_y_continuous(breaks = c(0, 100, 200, 300)) +
  ylim(0,350) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_x_discrete(breaks  = c("GG", "AG", "AA"),
                   labels = c("A", "A/V", "V")) +
  scale_fill_manual(name="Treatment By Family",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) +
  scale_color_manual(name="Treatment By Family ",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) 
```

##Conclusion
All we can really say is that the AA genotype (which produces the V) has significantly faster larval growth on the diet containing untreated leaf tissue.  BUT there is a trend that heterozygotes look to growth larger on the diet containing treated leaf tissue for both one and two toxin cultivars.  