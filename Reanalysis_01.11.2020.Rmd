---
title: "Linkage analysis for H.zea CHR13 marker with larval growth"
author: "Katherine Taylor and Megan Fritz"
date: "written Jan. 8, 2021"
output: github_document
---

##Parental strains used for linkage analysis
Summary statistics and distributions of 7 day larval weights for the strains used as grandparents for linkage analysis crosses. A population acquired from Benzon Laboratories was used as the susceptible strain (dark grey) and a field-collected population from MD was used as the resistant strain (light grey).  Panel A shows the distributions of weights on a diagnostic dose of a diet containing BC0805 (Cry1Ab) leaf tissue.  Panel B shows the distributions of weights on Obsession II (Cry1A.105+Cry2Ab2) leaf tissue.

```{r loading libraries, include = FALSE}

x <- c("magrittr", "lme4", "dplyr", "MASS", "ggplot2", "gridExtra", "grid", "lmtest") 

lapply(x, FUN = function(X) {
   do.call("library", list(X)) 
 })

```

```{r loading parental strain dataset, include = F}

F0_growth <- read.csv("~/Downloads/Tabash_Reanalysis/Family_cross_F0_growth_phenotypes.csv")

F0_growth <- F0_growth %>% 
   mutate(end_weight_mg = end_weight * 1000)
F0_growth <- F0_growth %>% 
   mutate(field = case_when(family == "Benzon" ~ "Benzon", TRUE ~ "Field"))

str(F0_growth)
```

```{r F0 summary statistics and plots}

F0_growth %>% 
   filter(end_weight_mg != "") %>% 
   group_by(diet_strain, field) %>%
   summarize(
     count = n(),
     mean = mean(end_weight_mg),
     median = median(end_weight_mg),
     sd = sd(end_weight_mg)
   )


#parents on BC0805
panelA <- F0_growth %>%
   filter(diet_strain == "P", end_weight_mg != "") %>%
   ggplot(aes(x = end_weight_mg, fill = field)) +
   geom_histogram(alpha = 0.5, position = "identity", bins = 20, color="black") +
   labs(x = "Weight (mg)", y = "Count", tag = "A") +
   theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
   scale_fill_manual(name="field",
                          breaks = c("Benzon", "Field"),
                           labels = c("Susceptible", "MD"),
                          values = c("grey20", "grey80")) +
   scale_y_continuous(limits = c(0, 55), breaks = c(0, 20, 40, 60)) +
   theme(axis.text=element_text(size=12),
         axis.title=element_text(size=14,face="bold"))+
   theme(legend.position = "none") 

panelA


#Parents on ObsII
panelB <- F0_growth %>%
   filter(diet_strain == "O", end_weight_mg != "") %>%
   ggplot(aes(x = end_weight_mg, fill = field)) +
    geom_histogram(alpha = 0.5, position = "identity", bins = 20, color="black") +
   labs(x = "Weight (mg)", y = "Count", tag = "B") +
   theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
   scale_fill_manual(name = "Population",
                          breaks = c("Benzon", "Field"),
                           labels = c("Susceptible", "MD"),
                          values = c("grey20", "grey80"))  +
   scale_y_continuous(limits = c(0, 55), breaks = c(0, 20, 40, 60)) + theme(legend.position = "none") +
   theme(axis.text=element_text(size=12),
         axis.title=element_text(size=14,face="bold")) 
 
panelB
```


##Testing for differences in final weight between the parental strains
```{r statistical analysis F0}

#subsetting the data by diet treatment
F0_BC0805 <- subset(F0_growth, diet_strain == "P")
F0_ObsII <- subset(F0_growth, diet_strain == "O")


#BC0805 treatment first.
fitF0_P <- aov(end_weight_mg ~ field, data = F0_BC0805)
summary(fitF0_P)#shows statistically significant differences in 7 day weights for Benzon and MD pops on BC0805 diet.

shapiro.test(resid(fitF0_P))#BC0805 dataset meets assumptions of normality, but barely.

#fitting a glm
fitF0_P1 <- glm(end_weight_mg ~ 1 + field, data = F0_BC0805, family = "gaussian")
summary(fitF0_P1)

fitF0_P2 <- glm(end_weight_mg ~ 1 + field, data = F0_BC0805, family = "Gamma")
summary(fitF0_P2)#this is the better fit according to AIC

#looking at distributions again
plot(fitF0_P1)
plot(fitF0_P2)#this does look better....

#model comparison with and without field.
fitF0_P2red <- glm(end_weight_mg ~ 1, data = F0_BC0805, family = "Gamma")

lrtest(fitF0_P2red,fitF0_P2)#statistically sig diff again



#ObsII treatment second
fitF0_O <- aov(end_weight_mg ~ field, data = F0_ObsII)
summary(fitF0_O) #statistically significant differences between Benzon and MD parents on ObsII diet.

shapiro.test(resid(fitF0_O))#ObsII does not meet assumptions of normality.

#trying a log10 transformation first
fitF0_OL <- aov(log10(end_weight_mg) ~ field, data = F0_ObsII)
summary(fitF0_OL)
shapiro.test(resid(fitF0_OL))#helps alot, but still does not meet assumptions of normality

#fitting a glm
fitF0_O1 <- glm(end_weight_mg ~ 1 + field, data = F0_ObsII, family = "gaussian")
summary(fitF0_O1)

fitF0_O2 <- glm(end_weight_mg ~ 1 + field, data = F0_ObsII, family = "Gamma")
summary(fitF0_O2)#this is the better fit according to AIC

#qq comparison of distributions.
plot(fitF0_O1)
plot(fitF0_O2)#again, looks better....

#model comparison with and without field.
fitF0_O2red <- glm(end_weight_mg ~ 1, data = F0_ObsII, family = "Gamma")

lrtest(fitF0_O2red,fitF0_O2)#statistically sig diff here too
```

##First mapping family - untreated vs. Cry1Ab leaf tissue incorporation assay
One F2 mapping family was generated and split into two groups at 48h after hatching - half were placed on diet with untreated leaf tissue (orange), the other half were placed on diet containing Cry1Ab treated leaf tissue (blue).  A second F2 mapping family was generated and also split into two groups at 48h after hatching - half were placed on diet containing Cry1A.105 + Cry2Ab2 treated leaf tissue (purple).  While we put the other half of the family on diet with untreated leaf tissue from a sweet corn isoline with the same genetic background as the two-toxin treated tissue, the data are not shown for simplicity. All larvae were allowed to feed for 7 days and then weighed.

```{r mapping family 1, include = FALSE}
genotypes1 <- read.csv("~/Downloads/Tabash_Reanalysis/genotypes_BV-BA52_BZM_P11_A1.csv", header = T)

phenotypes1 <- read.csv("~/Downloads/Tabash_Reanalysis/BV_BA52_P11_BZM_A1_Scored.csv", header = T)

phenotypes1 <- phenotypes1 %>% 
  mutate(end_weight_mg = Individual.Larvae.Weight * 1000)

BV_BA52_BZM_P11_A1 <- merge(phenotypes1, genotypes1, by = c("tray", "square", "row", "well"))

#cleaning up the data to exclude individuals with low quality genotypes.
BV_BA52_BZM_P11_A1_DD <- BV_BA52_BZM_P11_A1 %>%
  filter (Treatment == "DD") %>%
  filter (genotype_3749 != "", genotype_9409b != "") %>%
  filter (X9409b_low_quality != "*")

BV_BA52_BZM_P11_A1_CL <- BV_BA52_BZM_P11_A1 %>%
  filter (Treatment == "CL") %>%
  filter (genotype_9409b != "")%>%
  filter (X9409b_low_quality == "")
```

```{r Family 2, include = FALSE}
genotypes2 <- read.csv("~/Downloads/Tabash_Reanalysis/genotypes_BV_CV98_03_BZF_I9_9.16.20.csv")

phenotypes2 <- read.csv("~/Downloads/Tabash_Reanalysis/BV_CV98_O3_BZF_I9_Scored.csv")

phenotypes2 <- phenotypes2 %>% 
  mutate(end_weight_mg = Individual.Larvae.Weight * 1000)

BV_CV98_03_BZF_I9_DD <- merge(phenotypes2, genotypes2, by = c("tray", "square", "row", "well")) %>%
  filter (genotype_3749 != "")#no missing for genotype_9409b, only one low quality specified for 3749. 
BV_CV98_03_BZF_I9_DD$traySquare <- paste(BV_CV98_03_BZF_I9_DD$tray,"", BV_CV98_03_BZF_I9_DD$square)
```

```{r joining two datasets just for plot, include = FALSE}

joined <- data.frame(rbind(BV_BA52_BZM_P11_A1_DD[,c(6,7,12,16,18)], BV_BA52_BZM_P11_A1_CL[,c(6,7,12,16,18)], BV_CV98_03_BZF_I9_DD[,c(6,7,11,13,17)]))
joined$TreatByFam <- paste(joined$Population, "", joined$Treatment)


```

We genotyped all progeny at two loci in the 3Mb region - are they correlated?
```{r testing for correlations between genotypes}
joined$num9409b <- as.numeric(gsub("GG", 0, gsub("AG", 1, gsub("AA", 2, joined$genotype_9409b))))
joined$num3749 <- as.numeric(gsub("CC", 0, gsub("CT", 1, gsub("TT", 2, joined$genotype_3749))))

cor.test(joined$num9409b, joined$num3749, method = "kendall")#significant correlation between these two loci

```

Due to the significant correlation between genotypes at the two loci, just looking at cpq1 going forward.
```{r plot of 9409 genotypes ALL prog}
#good plot for presentation - 9409_b; AA is derived
joined %>%
  filter (genotype_9409b != "") %>%
ggplot(aes(x = genotype_9409b, y = end_weight_mg, fill = TreatByFam, color = TreatByFam)) +
  geom_boxplot(fatten = 1, alpha = 0.8, notch = F) +
  geom_point(position=position_jitterdodge(jitter.width = 0.3)) +
  labs(y = "Weight (mg)", x = "") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_y_continuous(breaks = c(0, 100, 200, 300)) +
  ylim(0,350) +
  scale_x_discrete(breaks  = c("GG", "AG", "AA"),
                   labels = c("A", "A/V", "V")) +
  scale_fill_manual(name="Treatment By Family",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) +
  scale_color_manual(name="Treatment By Family ",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) +
  theme(axis.text=element_text(size=12),
         axis.title=element_text(size=14,face="bold"))
```

```{r plot of 3749 if needed someday, include = FALSE}
#add'l plot for presentation - 3749; TT is derived
joined %>%
  filter (genotype_3749 != "") %>%
ggplot(aes(x = genotype_3749, y = end_weight_mg, fill = TreatByFam, color = TreatByFam)) +
  geom_boxplot(fatten = 1, alpha = 0.8, notch = F) +
  geom_point(position=position_jitterdodge(jitter.width = 0.3)) +
  labs(y = "Weight (mg)", x = "") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_y_continuous(breaks = c(0, 100, 200, 300)) +
  ylim(0,350) +
  scale_x_discrete(breaks  = c("CC", "CT", "TT"),
                   labels = c("S", "S/N", "N")) +
  scale_fill_manual(name="Treatment By Family",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) +
  scale_color_manual(name="Treatment By Family ",
                         breaks=c("Fam 1 CL", "Fam 1 DD", "Fam 2 DD"),
                         values=c("#E69F00", "#56B4E9", "#9932CC")) +
  theme(axis.text=element_text(size=12),
         axis.title=element_text(size=14,face="bold"))
```

```{r plots for pub}
#individual plots by family/treat
BV_BA52_BZM_P11_A1_CL %>%
ggplot(aes(x = genotype_9409b, y = end_weight_mg)) +
  geom_boxplot(fatten = 1, fill='#A4A4A4', color="black") + geom_jitter(position=position_jitter(0.2)) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  labs(y = "Weight (mg)", x = "", tag = "C") +
  scale_y_continuous(limits = c(0,400), breaks = c(0, 50, 100, 150, 200, 250, 300, 350)) +
  scale_x_discrete(breaks  = c("GG", "AG", "AA"), labels = c("A", "A/V", "V")) +
  theme(axis.text=element_text(size=14), 
        axis.title=element_text(size=16,face="bold"))

BV_BA52_BZM_P11_A1_DD %>%
ggplot(aes(x = genotype_9409b, y = end_weight_mg)) +
  geom_boxplot(fatten = 1, fill='#A4A4A4', color="black") + geom_jitter(position=position_jitter(0.2)) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  labs(y = "Weight (mg)", x = "", tag = "D") +
  scale_y_continuous(limits = c(0,350), breaks = c(0, 50, 100, 150, 200, 250, 300, 350)) +
  scale_x_discrete(breaks  = c("GG", "AG", "AA"),
                   labels = c("A", "A/V", "V")) +
  theme(axis.text=element_text(size=14),
         axis.title=element_text(size=16,face="bold"))


BV_CV98_03_BZF_I9_DD %>%
ggplot(aes(x = genotype_9409b, y = end_weight_mg)) +
  geom_boxplot(fatten = 1, fill='#A4A4A4', color="black") + geom_jitter(position=position_jitter(0.2)) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  labs(y = "Weight (mg)", x = "", tag = "E") +
  scale_y_continuous(limits = c(0,350), breaks = c(0, 50, 100, 150, 200, 250, 300,350)) +
  scale_x_discrete(breaks  = c("GG", "AG", "AA"),
                   labels = c("A", "A/V", "V")) +
 theme(axis.text=element_text(size=14),
         axis.title=element_text(size=16,face="bold"))


```

## Counts of larvae with each genotype & test for mendelian seg
```{r test of mendelseg}

exp_props <- c(0.25, 0.5, 0.25)

geno9409_dist_BCO805_DD <- as.matrix(table(BV_BA52_BZM_P11_A1_DD$genotype_9409b))#allele freqs diag dose BC0805
print(geno9409_dist_BCO805_DD[-1,])#AA is the derived genotype in the field
chisq.test(x = geno9409_dist_BCO805_DD[-1,], p = exp_props, simulate.p.value = T)

geno9409_dist_BCO805_CL <- as.matrix(table(BV_BA52_BZM_P11_A1_CL$genotype_9409b))#allele freqs control diet
print(geno9409_dist_BCO805_CL[-1,])#AA is the derived genotype in the field
chisq.test(x = geno9409_dist_BCO805_CL[-1,], p = exp_props, simulate.p.value = T)

geno9409_dist_Obs_DD <- as.matrix(table(BV_CV98_03_BZF_I9_DD $genotype_9409b))#allele freqs control diet
print(geno9409_dist_Obs_DD)#AA is the derived genotype in the field
chisq.test(x = geno9409_dist_Obs_DD, p = exp_props, simulate.p.value = T)


```


## Anova and data transformation
We check the assumptions with plots and a shapiro test. If not normally distributed, checking residuals and trying different transformations, as well as glms with different assumptions for distribution of residuals.

Progeny on treated diet

```{r linkage PDD Normality}
fitDD <- aov(end_weight_mg ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD)
summary(fitDD)

shapiro.test(resid(fitDD))
plot(fitDD)#a heavy-tailed distribution

```


Then tried a parametric tests with transformed responses.
```{r linkage PDD transformed}

fit_BV_BA52_BZM_P11_A1_DD1 <- aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD)
summary(fit_BV_BA52_BZM_P11_A1_DD1)
plot(fit_BV_BA52_BZM_P11_A1_DD1)

fit_BV_BA52_BZM_P11_A1_DD2 <- aov(log(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD)
summary(fit_BV_BA52_BZM_P11_A1_DD2)
plot(fit_BV_BA52_BZM_P11_A1_DD2)

fit_BV_BA52_BZM_P11_A1_DD3 <- aov((end_weight_mg^2) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD)
summary(fit_BV_BA52_BZM_P11_A1_DD3)
plot(fit_BV_BA52_BZM_P11_A1_DD3)

#log transformation looks to be the best fit


```


Parametric test for individuals raised up on untreated diet.
```{r linkage analysis PCL}
fit_BV_BA52_BZM_P11_A1_CL <- aov(end_weight_mg ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_CL)
summary(fit_BV_BA52_BZM_P11_A1_CL)

shapiro.test(resid(fit_BV_BA52_BZM_P11_A1_CL))#shows no transformation needed.
plot(fit_BV_BA52_BZM_P11_A1_CL)

```

#Adding a random effect of square = 1 syringe mixture does one square.
```{r glms to block on diet batch for P treatments}

#not putting this section in the markdown file because it didn't change anything.
fit_glmF <- lmer(log(end_weight_mg) ~ 1 + genotype_9409b + (1|square), data = BV_BA52_BZM_P11_A1_DD)
fit_glmR <- lmer(log(end_weight_mg) ~ 1 + (1|square),  data = BV_BA52_BZM_P11_A1_DD)

summary(fit_glmF)

lrtest(fit_glmR, fit_glmF)#adding the blocking factor doesn't change much.

#checking end weights by square
boxplot(BV_BA52_BZM_P11_A1_DD$end_weight_mg ~ BV_BA52_BZM_P11_A1_DD$square)


#now for the controls
fit_glmF <- lmer(end_weight_mg ~ 1 + genotype_9409b + (1|square), data = BV_BA52_BZM_P11_A1_CL)
fit_glmR <- lmer(end_weight_mg ~ 1 + (1|square), data = BV_BA52_BZM_P11_A1_CL)

summary(fit_glmF)

lrtest(fit_glmR, fit_glmF)#but the controls look like there may be statistically significant differences in growth.

#Checking end weights by square
boxplot(BV_BA52_BZM_P11_A1_CL$end_weight_mg ~ BV_BA52_BZM_P11_A1_CL$square)

```


#Do the distributions of the genotype frequencies differ for high and low weight gain individuals, per Tabashnik comments?
```{r checking the tails for P diets}
#Cry1Ab DD
quant_33 <- quantile(BV_BA52_BZM_P11_A1_DD$end_weight_mg, probs = c(0.33, 0.66))#also tried (0.25, 0.75) with no difference.
BV_BA52_BZM_P11_A1_DD_LO <- subset(BV_BA52_BZM_P11_A1_DD, end_weight_mg < quant_33[1]) 
geno9409_dist_BCO805_DDLO <- as.matrix(table(BV_BA52_BZM_P11_A1_DD_LO$genotype_9409b))
geno9409_dist_BCO805_DDLO
  
BV_BA52_BZM_P11_A1_DD_HI <- subset(BV_BA52_BZM_P11_A1_DD, end_weight_mg > quant_33[2])
geno9409_dist_BCO805_DDHI <- as.matrix(table(BV_BA52_BZM_P11_A1_DD_HI$genotype_9409b))
geno9409_dist_BCO805_DDHI

fisher.test(data.frame(cbind(geno9409_dist_BCO805_DDLO[-1],geno9409_dist_BCO805_DDHI[-1,])))

#Control 
quant_33 <- quantile(BV_BA52_BZM_P11_A1_CL$end_weight_mg, probs = c(0.33, 0.66))#changing quantiles to (0.25, 0.75) makes it not significant

BV_BA52_BZM_P11_A1_CL_LO <- subset(BV_BA52_BZM_P11_A1_CL, end_weight_mg < quant_33[1])
geno9409_dist_BCO805_CLLO <- as.matrix(table(BV_BA52_BZM_P11_A1_CL_LO$genotype_9409b))
geno9409_dist_BCO805_CLLO
  
BV_BA52_BZM_P11_A1_CL_HI <- subset(BV_BA52_BZM_P11_A1_CL, end_weight_mg > quant_33[2])
geno9409_dist_BCO805_CLHI <- as.matrix(table(BV_BA52_BZM_P11_A1_CL_HI$genotype_9409b))
geno9409_dist_BCO805_CLHI

fisher.test(data.frame(cbind(geno9409_dist_BCO805_CLLO[-1],geno9409_dist_BCO805_CLHI[-1,])))


```

```{r Excluding failure to thrive individuals, include = FALSE}
#Some progeny were still alive but with failure to thrive phenotypes, so we tried excluding them
#didn't change the outcome, so not including in the markdown file.

BV_BA52_BZM_P11_A1_DD_20 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 20)

summary(aov(log(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_20))

BV_BA52_BZM_P11_A1_DD_25 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 25)

summary(aov(log(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_25))

BV_BA52_BZM_P11_A1_DD_30 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 30)

summary(aov(log(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_30))

BV_BA52_BZM_P11_A1_DD_35 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 35)

summary(aov(log(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_35))

BV_BA52_BZM_P11_A1_DD_40 <- BV_BA52_BZM_P11_A1_DD %>%
  filter (end_weight_mg > 40)

summary(aov(log(end_weight_mg) ~ genotype_9409b, data = BV_BA52_BZM_P11_A1_DD_40))


```


##Second Mapping family - Cry1A.105 + Cry2Ab2 leaf tissue incorporation assay
Statistical analysis for the half of the second family on treated diet.

## Anova and data transformations
```{r}
fitDD <- aov(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD)
shapiro.test(resid(fitDD)) #suggests a transformation may not be needed.
plot(fitDD)

fitDD2 <- aov(sqrt(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD)
shapiro.test(resid(fitDD2))
plot(fitDD2)

fitDD3 <- aov(log(end_weight_mg) ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD)
shapiro.test(resid(fitDD3))
plot(fitDD3)

#untransformed data actually looks the best.
```


```{r tried glm for ObsII to add an effect of square}
#tried a glm too so that I could test whether adding a random effect of square impacted the model output

fit_glmF <- lmer(end_weight_mg ~ 1 + genotype_9409b + (1|traySquare), data = BV_CV98_03_BZF_I9_DD)
fit_glmR <- lmer(end_weight_mg ~ 1 + (1|traySquare), data = BV_CV98_03_BZF_I9_DD)

summary(fit_glmF)
summary(fit_glmR)#there is a singular fit issue, but could be triggered becuase this is a very simple model, where the random effect variance is estimated very near zero.   

coef(fit_glmF)

lrtest(fit_glmR, fit_glmF)

#the significance is surprising so looking at boxplot 
boxplot(BV_CV98_03_BZF_I9_DD$end_weight_mg ~ BV_CV98_03_BZF_I9_DD$traySquare)

#was there a weird distribution of genotypes across squares? No.
table(BV_CV98_03_BZF_I9_DD$genotype_9409b, BV_CV98_03_BZF_I9_DD$traySquare)


#adding traySquare as a fixed effect to test how much the singular fit issue influences statistical significance
fit_glmF2 <- lm(end_weight_mg ~ 1 + genotype_9409b + traySquare, data = BV_CV98_03_BZF_I9_DD)
fit_glmR2 <- lm(end_weight_mg ~ 1 + traySquare, data = BV_CV98_03_BZF_I9_DD)

lrtest(fit_glmR2,fit_glmF2)#still marginally significant
```

#Dist of the genotype frequencies for high and low weight gain individuals, per Tabashnik comments
```{r}
#Cry1A.105 + Cry2Ab2 DD
quant_33 <- quantile(BV_CV98_03_BZF_I9_DD$end_weight_mg, c(0.33, 0.66))#result does not differ if I change to (0.25, 0.75)
BV_CV98_03_BZF_I9_DD_LO <- subset(BV_CV98_03_BZF_I9_DD, end_weight_mg < quant_33[1])
geno9409_dist_ObsII_DDLO <- as.matrix(table(BV_CV98_03_BZF_I9_DD_LO$genotype_9409b))
geno9409_dist_ObsII_DDLO
  
BV_CV98_03_BZF_I9_DD_HI <- subset(BV_CV98_03_BZF_I9_DD, end_weight_mg > quant_33[2])
geno9409_dist_ObsII_DDHI <- as.matrix(table(BV_CV98_03_BZF_I9_DD_HI$genotype_9409b))
geno9409_dist_ObsII_DDHI

fisher.test(data.frame(cbind(geno9409_dist_ObsII_DDLO ,geno9409_dist_ObsII_DDHI)))

#I guess this doesn't really tell us anything without the effect of square incorporated in.

```

```{r again excluded small individuals, include = FALSE}

#this did not really help, so did not include the output in the markdown file
BV_CV98_03_BZF_I9_DD_20 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 20)

summary(aov(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_20))

BV_CV98_03_BZF_I9_DD_25 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 25)

summary(aov(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_25))

BV_CV98_03_BZF_I9_DD_30 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 30)

summary(aov(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_30))

BV_CV98_03_BZF_I9_DD_35 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 35)

summary(aov(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_35))

BV_CV98_03_BZF_I9_DD_40 <- BV_CV98_03_BZF_I9_DD %>%
  filter (end_weight_mg > 40)

summary(aov(end_weight_mg ~ genotype_9409b, data = BV_CV98_03_BZF_I9_DD_40))



```
